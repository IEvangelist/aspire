---
import { CardGrid, Card } from "@astrojs/starlight/components";
import IntegrationCard from "./IntegrationCard.astro";
import IntegrationTotals from "./IntegrationTotals.astro";

interface Props {
    integrations: Integrations;
}

const { integrations } = Astro.props;

interface Integration {
    title: string;
    href: string;
    icon: string;
    description: string;
    downloads?: number;
    version?: string;
    tags?: string[];
}

type Integrations = Integration[];

const sortedIntegrations = integrations.sort((a, b) => {
    const aDownloads = a.downloads ?? 0;
    const bDownloads = b.downloads ?? 0;
    return bDownloads - aDownloads; // Sort by downloads descending
});

// const hostingIntegrations = sortedIntegrations
//     .filter(
//         (pkg) => pkg.tags?.includes("hosting") || pkg.tags?.includes("testing"),
//     );

// const clientIntegrations = sortedIntegrations
//     .filter((pkg) => pkg.tags?.includes("client"));

// const tagCounts = new Map<string, number>();
// for (const pkg of integrations) {
//     for (const tag of pkg.tags ?? []) {
//         if (tag === "aspire") continue; // Ignore the 'aspire' tag
//         tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1);
//     }
// }

// const allTags = Array.from(tagCounts.entries())
//     .sort((a, b) => b[1] - a[1]) // Sort by count descending
//     .map(([tag, count]) => ({ tag, count }));
---

<div class="sl-mb-4 search-wrapper">
    <div class="search-container">
        <input
            autocomplete="off"
            type="text"
            class="search-box filter"
            placeholder="Search integrations..."
        />
    </div>
    <button class="clear-button" aria-label="Clear search" type="button"
        >Clear</button
    >
</div>

{
    sortedIntegrations.length > 0 && (
        <section>
            <div class="integration-stats">
                <IntegrationTotals integrations={sortedIntegrations} />
            </div>

            <div class="equal-columns">
                <CardGrid>
                    {sortedIntegrations.map((pkg) => (
                        <IntegrationCard pkg={pkg} />
                    ))}
                </CardGrid>
            </div>

            <div class="no-results">
                <Card title="No integrations found" icon="magnifier">
                    Try searching for things like <strong>"SQL"</strong>,
                    <strong>"Cache"</strong>, or <strong>"Testing"</strong> to
                    discover integrations!
                </Card>
            </div>
        </section>
    )
}
<style>
    .no-results {
        margin-top: 0;
        display: none; /* Hidden by default */
    }

    .integration-stats {
        margin-bottom: 1rem;
    }

    /* Force equal columns in the card grid */
    .equal-columns :global(.card-grid) {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        width: 100%;
    }

    /* Ensure each card takes exactly half the space */
    .equal-columns :global(.card-grid > *) {
        width: 100%;
        box-sizing: border-box;
        min-width: 0;
        max-width: 100%;
    }

    .search-wrapper {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        width: 100%;
    }

    .search-container {
        flex-grow: 1;
        position: relative;
    }

    input.filter {
        padding-inline: 0.75rem;
        background-color: var(--sl-color-black);
        color: var(--sl-color-text);
        font-size: var(--sl-text);
        width: 100%;
        height: 2.5rem;
        border: 1px solid var(--sl-color-gray-5);
        border-radius: 0.5rem;
        font-size: calc(21px * var(--pagefind-ui-scale));
        position: relative;
        display: flex;
        box-sizing: border-box;
    }

    .clear-button {
        background-color: var(--sl-color-gray-6);
        border: 1px solid var(--sl-color-gray-5);
        border-radius: 0.375rem;
        color: var(--sl-color-white);
        cursor: pointer;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        height: 2.5rem;
        margin-top: 0;
        transition: background-color 0.2s ease;
    }

    .clear-button:hover {
        background-color: var(--sl-color-gray-5);
    }
</style>

<script type="module" is:inline>
    const searchBox = document.querySelector(".search-box");
    const clearButton = document.querySelector(".clear-button");
    const cards = document.querySelectorAll(".card-grid .card");
    const noResults = document.querySelector(".no-results");
    const statsSection = document.querySelector(".integration-stats");

    let activeTags = new Set();

    const urlParams = new URLSearchParams(window.location.search);
    const initialSearch = urlParams.get("search") || "";

    if (initialSearch) {
        searchBox.value = initialSearch;
    }

    function updateURL() {
        const params = new URLSearchParams();
        if (activeTags.size > 0) params.set("tags", [...activeTags].join(","));
        if (searchBox.value.trim())
            params.set("search", searchBox.value.trim());
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.pushState({}, "", newUrl);
    }

    function clearSearch() {
        searchBox.value = "";
        filterCards();
        searchBox.focus();
    }

    function filterCards(updateUrl = true) {
        const searchTerm = searchBox.value.toLowerCase();
        let visibleCount = 0;

        cards.forEach((card) => {
            const cardTags = card.dataset.tags
                ? card.dataset.tags.split(",")
                : [];
            const cardTitle = card.dataset.title
                ? card.dataset.title.toLowerCase()
                : "";
            const cardDescription = card.dataset.description
                ? card.dataset.description.toLowerCase()
                : "";

            // Match against tags
            const matchesTags = [...activeTags].every((tag) =>
                cardTags.includes(tag),
            );

            // Check if search term appears in title, tags, or description
            const matchesSearch =
                !searchTerm ||
                cardTitle.includes(searchTerm) ||
                cardDescription.includes(searchTerm) ||
                cardTags.some((tag) => tag.toLowerCase().includes(searchTerm));

            const visible = matchesTags && matchesSearch;
            card.style.display = visible ? "" : "none";
            if (visible) visibleCount++;
        });

        // Show/hide the no results message based on visible count
        noResults.style.display = visibleCount === 0 ? "block" : "none";

        // Show/hide the stats based on visible count
        statsSection.style.display = visibleCount === 0 ? "none" : "block";

        if (updateUrl) updateURL();
    }

    searchBox.addEventListener("input", () => {
        filterCards();
    });

    clearButton.addEventListener("click", clearSearch);

    // Also clear when user presses Escape in the search box
    searchBox.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            clearSearch();
        }
    });

    window.addEventListener("popstate", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const search = urlParams.get("search") || "";

        searchBox.value = search;
        filterCards(false);
    });

    filterCards(); // Initial render
</script>
